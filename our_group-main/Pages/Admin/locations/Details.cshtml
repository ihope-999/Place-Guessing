@page "{id:int}"
@model our_group.Pages.Admin.Locations.DetailsModel
@attribute [Microsoft.AspNetCore.Authorization.Authorize(AuthenticationSchemes = "AdminCookie")]

<h2>Landmark Details</h2>

@if (Model.Item is null)
{
    <div class="alert alert-warning">Landmark not found.</div>
}
else
{
    <div class="mb-3">
        <a asp-page="/Admin/locations/Index" class="btn btn-secondary">Back</a>
    </div>

    <dl class="row">
        <dt class="col-sm-3">Id</dt>
        <dd class="col-sm-9">@Model.Item.Id</dd>

        <dt class="col-sm-3">Name</dt>
        <dd class="col-sm-9">@Model.Item.Name</dd>

        <dt class="col-sm-3">Address</dt>
        <dd class="col-sm-9">@Model.Item.Address</dd>

        <dt class="col-sm-3">Region</dt>
        <dd class="col-sm-9">@Model.Item.Region</dd>

        <dt class="col-sm-3">City</dt>
        <dd class="col-sm-9">@Model.Item.City</dd>

        <dt class="col-sm-3">Country</dt>
        <dd class="col-sm-9">@Model.Item.Country</dd>

        <dt class="col-sm-3">Category</dt>
        <dd class="col-sm-9">@Model.Item.Category</dd>

        <dt class="col-sm-3">Difficulty</dt>
        <dd class="col-sm-9">@Model.Item.Difficulty</dd>

        <dt class="col-sm-3">Average Rating</dt>
        <dd class="col-sm-9">@Model.Item.AverageRating</dd>

        <dt class="col-sm-3">Last Cached</dt>
        <dd class="col-sm-9">@Model.Item.LastCached</dd>
    </dl>

    <h3>Admin Controls</h3>
    <form method="post" asp-page-handler="Update">
        <input type="hidden" name="id" value="@Model.Item?.Id" />
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" asp-for="AdminInput.IsActive" id="isActiveChk" />
                    <label class="form-check-label" for="isActiveChk">In Rotation (Active)</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" asp-for="AdminInput.IsBroken" id="isBrokenChk" />
                    <label class="form-check-label" for="isBrokenChk">Broken</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" asp-for="AdminInput.IsInappropriate" id="isInappChk" />
                    <label class="form-check-label" for="isInappChk">Inappropriate</label>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label class="form-label" asp-for="AdminInput.ManualDifficulty">Manual Difficulty</label>
                <select class="form-select" asp-for="AdminInput.ManualDifficulty">
                    <option value="">Auto (from reviews)</option>
                    <option value="1">1 - Very Easy</option>
                    <option value="2">2 - Easy</option>
                    <option value="3">3 - Medium</option>
                    <option value="4">4 - Hard</option>
                    <option value="5">5 - Very Hard</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label" asp-for="AdminInput.CategoryOverride">Category Override</label>
                <select class="form-select" asp-for="AdminInput.CategoryOverride">
                    <option value="">Keep (@Model.Item.Category)</option>
                    <option>Landmark</option>
                    <option>Museum</option>
                    <option>Restaurant</option>
                    <option>Park</option>
                    <option>HistoricalSite</option>
                    <option>NaturalWonder</option>
                    <option>ReligiousSite</option>
                    <option>Shopping</option>
                    <option>Entertainment</option>
                    <option>Hotel</option>
                    <option>City</option>
                    <option>Country</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </form>

    <form method="post" asp-page-handler="Refresh" class="mt-3">
        <input type="hidden" name="id" value="@Model.Item?.Id" />
        <button type="submit" class="btn btn-outline-secondary">Refresh Reviews from Google</button>
    </form>

    <h3 class="mt-4">Review Quality Filters</h3>
    <form method="post" asp-page-handler="Quality" class="row g-3 mb-3">
        <input type="hidden" name="id" value="@Model.Item?.Id" />
        <div class="col-md-3">
            <label class="form-label">Minimum Stars</label>
            <select class="form-select" asp-for="QualityInput.MinStars">
                <option value="">No minimum</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Minimum Text Length</label>
            <input type="number" class="form-control" asp-for="QualityInput.MinLength" min="0" placeholder="e.g. 30" />
        </div>
        <div class="col-md-3 align-self-end">
            <button type="submit" class="btn btn-success">Apply Filters</button>
        </div>
    </form>

    <div class="mt-4">
        <h5>Filter by Star Rating</h5>
        <div class="btn-group" role="group">
            <a class="btn btn-sm @(Model.SelectedRating is null ? "btn-primary" : "btn-outline-primary")" asp-page="/Admin/locations/Details" asp-route-id="@Model.Id">All (@Model.Reviews.Count)</a>
            @for (int s = 1; s <= 5; s++)
            {
                var count = Model.StarBuckets.ContainsKey(s) ? Model.StarBuckets[s] : 0;
                var active = Model.SelectedRating == s;
                <a class="btn btn-sm @(active ? "btn-primary" : "btn-outline-primary")" asp-page="/Admin/locations/Details" asp-route-id="@Model.Id" asp-route-rating="@s">@s&#9733; (@count)</a>
            }
        </div>
    </div>

    <h3>Reviews (@Model.Reviews.Count)</h3>
    @if (!Model.Reviews.Any())
    {
        <p class="text-muted">No reviews.</p>
    }
    else
    {
        var minStars = Model.QualityThresholds.MinStars;
        var minLen = Model.QualityThresholds.MinLength ?? 0;
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Stars</th>
                    <th>Author</th>
                    <th>Text</th>
                    <th>Cached</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            @foreach (var r in Model.Reviews)
            {
                var isFlagged = Model.FlaggedReviewIds.Contains(r.Id);
                var isBelowStars = minStars.HasValue && r.StarRating < minStars.Value;
                var isBelowLen = (r.Text?.Length ?? 0) < minLen;
                var isFiltered = isFlagged || isBelowStars || isBelowLen;
                <tr>
                    <td>@r.Id</td>
                    <td>
                        @{
                            var filled = new string('★', Math.Clamp(r.StarRating, 0, 5));
                            var empty = new string('☆', Math.Clamp(5 - r.StarRating, 0, 5));
                        }
                        <span class="text-warning" style="font-size: 0.95rem;">@filled</span><span class="text-muted" style="font-size: 0.95rem;">@empty</span>
                    </td>
                    <td>@r.AuthorName</td>
                    <td class="@(isFiltered ? "text-muted" : "")">@r.Text</td>
                    <td>@r.LastCachedAt</td>
                    <td>
                        @if (isFlagged) { <span class="badge bg-danger">Flagged</span> }
                        @if (isBelowStars) { <span class="badge bg-warning text-dark">Low Stars</span> }
                        @if (isBelowLen) { <span class="badge bg-info text-dark">Short</span> }
                        @if (!isFiltered) { <span class="badge bg-success">OK</span> }
                    </td>
                    <td>
                        <form method="post" asp-page-handler="Flag" class="d-inline">
                            <input type="hidden" name="id" value="@Model.Item?.Id" />
                            <input type="hidden" name="reviewId" value="@r.Id" />
                            <input type="hidden" name="flag" value="@(!isFlagged)" />
                            @if (isFlagged)
                            {
                                <button type="submit" class="btn btn-sm btn-outline-secondary">Unflag</button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-sm btn-outline-danger">Flag</button>
                            }
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }
}
